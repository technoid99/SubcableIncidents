<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cable Incidents</title>
    <!-- Include marked for Markdown and Papaparse for CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!--include Tailwind CSS-->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"></link>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

    </style>
    <!-- Include Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
</head>
<body class="bg-gray-100">
    <div class="max-w-3xl mx-auto p-6">

        <!--search bar-->
        <div class="flex items-center bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex-grow flex items-center">
                <i class="fas fa-search text-gray-400 mr-3"></i>
                <input type="search" id="searchBox" placeholder="Keyword search for cable incidents and events..." class="w-full text-sm text-gray-800 placeholder-gray-400 border-none p-2">
            </div>
            <button id="filterToggle" class="ml-4 text-blue-500">
                <i class="fas fa-filter"></i>
            </button>
        </div>

        <!--filter panel-->
        <div id="SearchFilters" class="hidden bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex items-center mb-4">
                <label class="w-1/4 text-sm font-medium text-gray-700 hidden sm:block">Year</label>
                <select id="yearFilter" class="w-full sm:w-3/4 text-sm text-gray-800 bg-gray-50 rounded-lg border border-gray-300 p-2">
                    <option>Year</option>
                </select>
            </div>
            <div class="flex items-center mb-4">
                <label class="w-1/4 text-sm font-medium text-gray-700 hidden sm:block">Cable Name</label>
                <select id="cableFilter" class="w-full sm:w-3/4 text-sm text-gray-800 bg-gray-50 rounded-lg border border-gray-300 p-2">
                    <option>Cable Name</option>
                </select>
            </div>
            <div class="flex items-center mb-4">
                <label class="w-1/4 text-sm font-medium text-gray-700 hidden sm:block">Type of Incident</label>
                <select id="typeFilter" class="w-full sm:w-3/4 text-sm text-gray-800 bg-gray-50 rounded-lg border border-gray-300 p-2">
                    <option>Type of Incident</option>
                </select>
            </div>
            <div class="flex items-center mb-4">
                <label class="w-1/4 text-sm font-medium text-gray-700 hidden sm:block">Cause</label>
                <select id="causeFilter" class="w-full sm:w-3/4 text-sm text-gray-800 bg-gray-50 rounded-lg border border-gray-300 p-2">
                    <option>Cause</option>
                </select>
            </div>
            <div class="flex items-center mb-4">
                <label class="w-1/4 text-sm font-medium text-gray-700 hidden sm:block">Country</label>
                <select id="countryFilter" class="w-full sm:w-3/4 text-sm text-gray-800 bg-gray-50 rounded-lg border border-gray-300 p-2">
                    <option>Country</option>
                </select>
            </div>
            <div class="flex items-center mb-4">
                <label class="w-1/4 text-sm font-medium text-gray-700 hidden sm:block">Company</label>
                <select id="companyFilter" class="w-full sm:w-3/4 text-sm text-gray-800 bg-gray-50 rounded-lg border border-gray-300 p-2">
                    <option>Company</option>
                </select>
            </div>

            <!-- Buttons for clearing and applying filters -->
            <div class="flex justify-end mt-4">
                <button type="button" class="text-blue-500 border border-blue-500 hover:bg-blue-500 hover:text-white px-4 py-2 rounded transition duration-200 ease-in-out " onclick="filterBlogEntries()">Apply Filter</button>
                <button type="button" class="text-gray-700 border border-gray-300 hover:bg-gray-200 hover:text-white px-4 py-2 rounded transition duration-200 ease-in-out ml-2" onclick="resetFilters()">Clear All</button>
            </div>
        </div>

        <div class="row mb-6" id="activefilters"></div>


        <div class="bg-white rounded-lg shadow p-6" id="resultsPanel">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div id="resultsNumber" class="align-bottom" style="margin: 10px; margin-bottom:5px; color: rgb(126, 122, 122)"></div>
                        <select id="sortOrder" class="form-select form-select-sm" style="margin: 10px; margin-bottom:5px; width: auto;">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                    </div>
                    <div id="blogContainer"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container-fluid" style="background-color: white;">
        <div class="container" id="resultsPanelx">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div id="resultsNumber" class="align-bottom" style="margin: 10px; margin-bottom:5px; color: rgb(126, 122, 122)"></div>
                        <select id="sortOrder" class="form-select form-select-sm" style="margin: 10px; margin-bottom:5px; width: auto;">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#chartDisplay" aria-expanded="false" aria-controls="chartDisplay">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                    <path d="M7.25 6a.75.75 0 0 0-.75.75v7.5a.75.75 0 0 0 1.5 0v-7.5A.75.75 0 0 0 7.25 6ZM12 6a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 0 1.5 0v-4.5A.75.75 0 0 0 12 6Zm4.75a.75.75 0 0 1 1.5 0v9.5a.75.75 0 0 1-1.5 0v-9.5Z"></path>
                                </svg>                          
                            </button>
                        </h2>
                        <div id="chartDisplay" class="accordion-collapse collapse" aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlushExample">
                            <canvas id="histogram" class="accordion-body"></canvas>
                        </div>
                    </div>
                    <div id="blogContainerx"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let originalData; // Variable to store the original data from CSV

        // Function to fetch and parse the CSV file
        async function fetchCSV() {
            const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQwM2mfSIQK_-lAYzBvFQ-EX0Jq3XfwHETZkpY8I4pahueBF28Z4j6m_d1k2_Z3tcXdw2VhpvenZNbO/pub?gid=0&single=true&output=csv');
            const csvText = await response.text();
            const parsedData = Papa.parse(csvText, { header: true }).data;
            originalData = parsedData; // Store original data
            return parsedData;
        }

        // Function to clear the container
        function clearContainer() {
            const container = document.getElementById('blogContainer');
            container.innerHTML = '';
        }

        // Function to populate filter options
        function populateFilterOptions(data) {
            // Initialize filter dropdowns with a default option
            const filters = ['yearFilter', 'cableFilter', 'typeFilter', 'causeFilter', 'countryFilter', 'companyFilter'];
            filters.forEach(filterId => {
                const filterElement = document.getElementById(filterId);
                filterElement.innerHTML = `<option value="">${filterId.replace('Filter', '')}</option>`;
            });

            // Extract unique years for the yearFilter and sort them in descending order
            const uniqueYears = new Set();
            data.forEach(entry => {
                const year = entry.Date.split('/')[1]; // Extract the year part from the date string
                uniqueYears.add(year);
            });
            const sortedYears = Array.from(uniqueYears).sort((a, b) => b - a); // Sort in descending order

            // Populate the yearFilter dropdown with unique years
            const yearFilterElement = document.getElementById('yearFilter');
            sortedYears.forEach(year => {
                yearFilterElement.innerHTML += `<option value="${year}">${year}</option>`;
            });

            // Extract unique values for each filter
            const uniqueValues = {
                year: new Set(),
                cable: new Set(),
                type: new Set(),
                cause: new Set(),
                country: new Set(),
                company: new Set()
            };

            data.forEach(entry => {
                ['Date', 'Cable', 'Type', 'Cause', 'Country', 'Company'].forEach((key, index) => {
                    entry[key].split(', ').forEach(value => {
                        const trimmedValue = value.trim();
                        if (trimmedValue !== '') {
                            uniqueValues[filters[index].replace('Filter', '')].add(trimmedValue);
                        }
                    });
                });
            });

            // Convert Sets to arrays and sort them alphabetically
            const sortedValues = {};
            Object.keys(uniqueValues).forEach(key => {
                sortedValues[key] = Array.from(uniqueValues[key]).sort();
            });

            // Populate dropdown options with sorted values, excluding the yearFilter
            filters.filter(filterId => filterId !== 'yearFilter').forEach(filterId => {
                const filterElement = document.getElementById(filterId);
                const values = sortedValues[filterId.replace('Filter', '')];
                values.forEach(value => {
                    filterElement.innerHTML += `<option value="${value}">${value}</option>`;
                });
            });
        }

        // Function to sort based on input. Created for resultsPanel
        function sortData(data, order) {
            return data.sort((a, b) => {
                const dateA = new Date(a.Date.split('/')[1], a.Date.split('/')[0] - 1);
                const dateB = new Date(b.Date.split('/')[1], b.Date.split('/')[0] - 1);
                return order === 'newest' ? dateB - dateA : dateA - dateB; // Sort in descending or ascending order based on the order parameter
            });
        }

        // Function to update the results count
        function updateResultsCount() {
            const resultsContainer = document.getElementById('blogContainer');
            const resultsCount = resultsContainer.children.length;
            const resultsNumberElement = document.getElementById('resultsNumber');
            resultsNumberElement.textContent = `Showing ${resultsCount} result(s)`;
        }

        // Define a mapping object for column names to filter IDs
        const columnToFilterIdMap = {
            'Country': 'countryFilter',
            'Cable': 'cableFilter',
            'Type': 'typeFilter',
            'Cause': 'causeFilter',
            'Company': 'companyFilter'
        };

        // Function to generate blog entries
        function generateBlogEntries(data, sortOrder) {
            clearContainer();
            populateFilterOptions(data);
            const sortedData = sortData(data, sortOrder);

            sortedData.forEach(entry => {
                const [month, year] = entry.Date.split('/');
                const date = new Date(year, month - 1); // Note: months are 0-indexed in JavaScript
                const formattedDate = date.toLocaleString('default', { month: 'long', year: 'numeric' });

                // Create a Bootstrap card for each entry
                const card = document.createElement('div');
                card.className = 'card';
                card.style.marginBottom = '10px';
                card.style.padding = '15px';
                card.style.border = '1px solid #000'; // Thin black border
                card.style.borderRadius = '0.25rem'; // Rounded corners


                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';

                const descriptionHtml = marked.parse(entry.Details);
                const cleanedDescriptionHtml = descriptionHtml.replace(/<\/?p>/g, '');

                cardBody.innerHTML = `<p><b>${formattedDate}</b> - ${cleanedDescriptionHtml}</p>`;

                // Create badges for each tag
                const tags = ['Country', 'Cable', 'Type', 'Cause', 'Company'];
                tags.forEach(tag => {
                    const tagValues = entry[tag].split(', ');
                    tagValues.forEach(value => {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-primary';
                        badge.textContent = value.trim();
                        badge.style.marginRight = '5px';
                        badge.style.cursor = 'pointer';
                        badge.addEventListener('click', function() {
                            const filterId = `${tag.toLowerCase()}Filter`; // Construct the filter ID dynamically
                            document.getElementById(filterId).value = value.trim();
                            // Trigger the filter function to update the displayed entries
                            filterBlogEntries();
                        });
                        cardBody.appendChild(badge);
                    });
                });

                card.appendChild(cardBody);
                document.getElementById('blogContainer').appendChild(card);
            });

            // Update the results count after generating the entries
            updateResultsCount();
        }

        // Function to reset filters
        function resetFilters() {
            document.getElementById('searchBox').value = '';
            document.getElementById('yearFilter').value = '';
            document.getElementById('cableFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('causeFilter').value = '';
            document.getElementById('countryFilter').value = '';
            document.getElementById('companyFilter').value = '';

            originalData.sort((a, b) => {
                const dateA = new Date(a.Date.split('/')[1], a.Date.split('/')[0] - 1);
                const dateB = new Date(b.Date.split('/')[1], b.Date.split('/')[0] - 1);
                return dateB - dateA; // Sort in descending order
            });

            // After resetting, update the results count
            updateResultsCount();
            
            // Update the display of active filters
            updateActiveFiltersDisplay();

            // Generate blog entries with the original data, effectively removing any filters
            generateBlogEntries(originalData); 
        }

        // Function to update the display of active filters
        function updateActiveFiltersDisplay() {
            const filters = ['yearFilter', 'cableFilter', 'typeFilter', 'causeFilter', 'countryFilter', 'companyFilter'];
            const activeFilters = filters.reduce((acc, filterId) => {
                const filterValue = document.getElementById(filterId).value;
                if (filterValue) {
                    // Assuming each filter value is a single string, add it to the accumulator
                    acc.push(filterValue);
                }
                return acc;
            }, []);

            const activeFiltersDiv = document.getElementById('activefilters');
            activeFiltersDiv.innerHTML = ''; // Clear the current display

            if (activeFilters.length > 0) {
                // Concatenate active filters with " AND "
                const activeFiltersText = activeFilters.join(' AND ');
                activeFiltersDiv.textContent = `Active Filter(s): ${activeFiltersText}`;
            } else {
                activeFiltersDiv.textContent = 'Active Filter(s): No active filters.';
            }
        }

        // Variable to store the filtered data
        let filteredData = [];

        function aggregateDataByYear(data) {
            const yearCounts = {};
            data.forEach(entry => {
                const year = entry.Date.split('/')[1]; // Extract the year from the date string
                if (yearCounts[year]) {
                    yearCounts[year]++;
                } else {
                    yearCounts[year] = 1;
                }
            });
            return yearCounts;
        }

        function createHistogramChart(yearCounts) {
            const ctx = document.getElementById('histogram').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar', // Specify the chart type
                data: {
                    labels: Object.keys(yearCounts), // Use the years as labels
                    datasets: [{
                        data: Object.values(yearCounts), // Use the counts as data
                        backgroundColor: 'rgba(75, 192, 192, 0.2)', // Customize the bar color
                        borderWidth: 1, // Add a border to the bars
                        barPercentage: 0.5, // Make the bars narrower
                        categoryPercentage: 0.5 // Make the bars narrower
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true,
                            }
                        }],
                        yAxis: {
                            title: {
                                display: true,
                                text: '# of results',
                            },
                            ticks: {
                                callback: function(value, index ) {
                                    return Number.isInteger(value) ? value : undefined; // This ensures that the ticks are displayed as whole numbers
                                }
                            }
                        },
                        xAxis: {
                            title: {
                                display: true,
                                text: 'year',
                            },
                        }
                    },
    
                    plugins: {
                        legend: {
                            display: true,
                            text: '# of results'
                        }
                    },
                    title: {
                        display: false,
                        text: 'Results vs Year' // Set the chart title
                    }
                }
            });

            return chart; // Return the chart instance for potential updates
        }

        // Function to filter blog entries
        function filterBlogEntries(searchQuery = '') {
            
            // ***Filtering logic***

            // Retrieve current filter values
            const year = document.getElementById('yearFilter').value;
            const cable = document.getElementById('cableFilter').value;
            const type = document.getElementById('typeFilter').value;
            const cause = document.getElementById('causeFilter').value;
            const country = document.getElementById('countryFilter').value;
            const company = document.getElementById('companyFilter').value;

            // Filter the entries based on the selected filters and search query
            filteredData = originalData.filter(entry => {
                const entryYear = entry.Date.split('/')[1]; // Extract the year from the entry's date
                const searchMatch = searchQuery === '' || entry.Details.toLowerCase().includes(searchQuery.toLowerCase());
                return searchMatch &&
                    (year === '' || entryYear === year) &&       
                    (cable === '' || entry.Cable.includes(cable)) &&
                    (type === '' || entry.Type.includes(type)) &&
                    (cause === '' || entry.Cause.includes(cause)) &&
                    (country === '' || entry.Country.includes(country)) &&
                    (company === '' || entry.Company.includes(company));
            });

            // Construct the URL fragment representing the current search state
            let urlFragment = '?';
            Object.entries(filters).forEach(([key, value]) => {
                if (value) {
                    urlFragment += `${encodeURIComponent(key)}=${encodeURIComponent(value)}&`;
                }
            });

            // Append the search query to the URL fragment
            urlFragment += `search=${encodeURIComponent(searchQuery)}`;

            // Update the browser's address bar with the constructed URL fragment
            history.pushState({}, '', urlFragment);

            // ***Update the UI***

            // Sort the filtered entries by month and year
            filteredData.sort((a, b) => {
                const dateA = new Date(a.Date.split('/')[1], a.Date.split('/')[0] - 1);
                const dateB = new Date(b.Date.split('/')[1], b.Date.split('/')[0] - 1);
                return dateB - dateA; // Sort in descending order
            });

            // After filtering, update the results count
            updateResultsCount();

            // After applying filters, update the display of active filters
            updateActiveFiltersDisplay();

            // After filtering, aggregate data by year
            const yearCounts = aggregateDataByYear(filteredData);

            // Create the histogram chart
            createHistogramChart(yearCounts);

            // Retrieve the current sort order from the dropdown
            const sortOrder = document.getElementById('sortOrder').value;

            // Sort the filtered entries based on the current sort order
            const sortedData = sortData(filteredData, sortOrder);
            
            // Now, generate the blog entries with the sorted and filtered data
            generateBlogEntries(sortedData, sortOrder);

        }

        // Helper function to update the URL with the current search parameters
        function updateURLWithSearchParameters(searchQuery, filters) {
            let urlFragment = '?';
            Object.entries(filters).forEach(([key, value]) => {
                if (value) {
                    urlFragment += `${encodeURIComponent(key)}=${encodeURIComponent(value)}&`;
                }
            });
            urlFragment += `search=${encodeURIComponent(searchQuery)}`;
            history.pushState({}, '', urlFragment);
        }

        // Function to initialize the page with search parameters from the URL
        function initializePageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const searchQuery = urlParams.get('search') || '';
            const filters = {};

            // Example: If the URL contains "?year=2022", set the year filter to 2022
            // You'll need to implement the logic to extract and set filter values based on your application's structure

            // Fetch data and apply initial filters and search
            fetchCSV().then(data => {
                originalData = data;
                const defaultSortOrder = "newest";
                //filterBlogEntries(searchQuery);
                generateBlogEntries(data, defaultSortOrder);
                updateActiveFiltersDisplay();
                createHistogramChart(aggregateDataByYear(data));
            });
        }

        // Event listeners for the search box and filter dropdowns
        document.addEventListener('DOMContentLoaded', function() {
            initializePageFromURL();

            // Event listener for the filter toggle button
            document.getElementById('filterToggle').addEventListener('click', function() {
                var filterPanel = document.getElementById('SearchFilters'); // Adjusted to match the original ID
                filterPanel.classList.toggle('hidden');
            });
            
            // Event listener for the search box
            document.getElementById('searchBox').addEventListener('input', function() {
                const searchQuery = this.value;
                updateURLWithSearchParameters(searchQuery, {});
                filterBlogEntries(searchQuery);
            });

            // Event listeners for the filter dropdowns
            const filters = ['yearFilter', 'cableFilter', 'typeFilter', 'causeFilter', 'countryFilter', 'companyFilter'];
            filters.forEach(filterId => {
                document.getElementById(filterId).addEventListener('change', function() {
                    const filtersObj = {}; // Collect filter values into an object
                    filters.forEach(id => {
                        filtersObj[id] = document.getElementById(id).value;
                    });
                    updateURLWithSearchParameters('', filtersObj);
                    filterBlogEntries('', filtersObj);
                });
            });

            // Event listener for the sort order dropdown
            document.getElementById('sortOrder').addEventListener('change', function() {
                const sortOrder = this.value;
                const sortedData = sortData(filteredData, sortOrder);
                generateBlogEntries(sortedData, sortOrder);
            });
        });
        
    </script>
</body>
</html>
