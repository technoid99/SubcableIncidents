<!--ToDo:
1) Tailwind https://tailwindcss.com/docs/installation
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cable Incidents</title>
    <!-- Include marked for Markdown and Papaparse for CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!--include Tailwind CSS-->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"></link>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
        }

    </style>
    <!-- Include Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
</head>
<body class="bg-gray-100">
    <div class="max-w-3xl mx-auto p-6">

        <!--search bar-->
        <div class="flex items-center bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex-grow flex items-center">
                <i class="fas fa-search text-gray-400 mr-3"></i>
                <input type="search" id="searchBox" placeholder="Keyword search for cable incidents and events..." class="w-full text-sm text-gray-800 placeholder-gray-400 border-none p-2">
            </div>
            <button id="filterToggle" class="ml-4 text-blue-500">
                <i class="fas fa-filter"></i>
            </button>
        </div>

        <!--filter panel-->
        <div id="searchFilters" class="hidden bg-white rounded-lg shadow p-6 mb-6">
            <p style="margin-bottom: 20px;">Advanced Filter</p>
            <div class="flex items-center mb-4">
                <label class="w-1/4 text-sm font-medium text-gray-700 hidden sm:block">Year</label>
                <select id="yearFilter" class="w-full sm:w-3/4 text-sm text-gray-800 bg-gray-50 rounded-lg border border-gray-300 p-2">
                    <option>Year</option>
                </select>
            </div>
            <div class="flex items-center mb-4">
                <label class="w-1/4 text-sm font-medium text-gray-700 hidden sm:block">Cable Name</label>
                <select id="cableFilter" class="w-full sm:w-3/4 text-sm text-gray-800 bg-gray-50 rounded-lg border border-gray-300 p-2">
                    <option>Cable Name</option>
                </select>
            </div>
            <div class="flex items-center mb-4">
                <label class="w-1/4 text-sm font-medium text-gray-700 hidden sm:block">Type of Event</label>
                <select id="typeFilter" class="w-full sm:w-3/4 text-sm text-gray-800 bg-gray-50 rounded-lg border border-gray-300 p-2">
                    <option>Type of Event</option>
                </select>
            </div>
            <div class="flex items-center mb-4">
                <label class="w-1/4 text-sm font-medium text-gray-700 hidden sm:block">Cause</label>
                <select id="causeFilter" class="w-full sm:w-3/4 text-sm text-gray-800 bg-gray-50 rounded-lg border border-gray-300 p-2">
                    <option>Cause</option>
                </select>
            </div>
            <div class="flex items-center mb-4">
                <label class="w-1/4 text-sm font-medium text-gray-700 hidden sm:block">Country</label>
                <select id="countryFilter" class="w-full sm:w-3/4 text-sm text-gray-800 bg-gray-50 rounded-lg border border-gray-300 p-2">
                    <option>Country</option>
                </select>
            </div>
            <div class="flex items-center mb-4">
                <label class="w-1/4 text-sm font-medium text-gray-700 hidden sm:block">Company</label>
                <select id="companyFilter" class="w-full sm:w-3/4 text-sm text-gray-800 bg-gray-50 rounded-lg border border-gray-300 p-2">
                    <option>Company</option>
                </select>
            </div>

            <!-- Buttons for clearing and applying filters -->
            <div class="flex justify-end mt-4">
                <button type="button" class="text-blue-500 border border-blue-500 hover:bg-blue-500 hover:text-white px-4 py-2 rounded transition duration-200 ease-in-out " onclick="filterBlogEntries()">Apply Filter</button>
                <button type="button" class="text-gray-700 border border-gray-300 hover:bg-gray-200 hover:text-white px-4 py-2 rounded transition duration-200 ease-in-out ml-2" onclick="resetFilters()">Clear All</button>
            </div>
        </div>

        <div class="row mb-6" id="activefilters"></div>


        <div class="bg-white rounded-lg shadow p-6" id="resultsPanel">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div id="resultsNumber" class="align-bottom" style="margin: 10px; margin-bottom:5px; color: rgb(126, 122, 122)"></div>
                        <select id="sortOrder" class="form-select form-select-sm" style="margin: 10px; margin-bottom:5px; width: auto;">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                    </div>
                    <div id="blogContainer"></div>
                </div>
            </div>
        </div>
    </div>
    
 

<script>
    let originalData; // Variable to store the original data from CSV

    // Function to fetch and parse the CSV file
    async function fetchCSV() {
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQwM2mfSIQK_-lAYzBvFQ-EX0Jq3XfwHETZkpY8I4pahueBF28Z4j6m_d1k2_Z3tcXdw2VhpvenZNbO/pub?gid=0&single=true&output=csv');
        const csvText = await response.text();
        const parsedData = Papa.parse(csvText, { header: true }).data;
        originalData = parsedData; // Store original data
        return parsedData;
    }

    // Function to clear the container
    function clearContainer() {
        const container = document.getElementById('blogContainer');
        container.innerHTML = '';
    }

    // Function to populate filter options
    function populateFilterOptions(data) {
        // Initialize filter dropdowns with a default option
        const filters = ['yearFilter', 'cableFilter', 'typeFilter', 'causeFilter', 'countryFilter', 'companyFilter'];
        filters.forEach(filterId => {
            const filterElement = document.getElementById(filterId);
            filterElement.innerHTML = `<option value="">${filterId.replace('Filter', '')}</option>`;
        });

        // Extract unique years for the yearFilter and sort them in descending order
        const uniqueYears = new Set();
        data.forEach(entry => {
            const year = entry.Date.split('/')[1]; // Extract the year part from the date string
            uniqueYears.add(year);
        });
        const sortedYears = Array.from(uniqueYears).sort((a, b) => b - a); // Sort in descending order

        // Populate the yearFilter dropdown with unique years
        const yearFilterElement = document.getElementById('yearFilter');
        sortedYears.forEach(year => {
            yearFilterElement.innerHTML += `<option value="${year}">${year}</option>`;
        });

        // Extract unique values for each filter
        const uniqueValues = {
            year: new Set(),
            cable: new Set(),
            type: new Set(),
            cause: new Set(),
            country: new Set(),
            company: new Set()
        };

        data.forEach(entry => {
            ['Date', 'Cable', 'Type', 'Cause', 'Country', 'Company'].forEach((key, index) => {
                entry[key].split(', ').forEach(value => {
                    const trimmedValue = value.trim();
                    if (trimmedValue !== '') {
                        uniqueValues[filters[index].replace('Filter', '')].add(trimmedValue);
                    }
                });
            });
        });

        // Convert Sets to arrays and sort them alphabetically
        const sortedValues = {};
        Object.keys(uniqueValues).forEach(key => {
            sortedValues[key] = Array.from(uniqueValues[key]).sort();
        });

        // Populate dropdown options with sorted values, excluding the yearFilter
        filters.filter(filterId => filterId !== 'yearFilter').forEach(filterId => {
            const filterElement = document.getElementById(filterId);
            const values = sortedValues[filterId.replace('Filter', '')];
            values.forEach(value => {
                filterElement.innerHTML += `<option value="${value}">${value}</option>`;
            });
        });
    }

    // Function to sort based on input. Created for resultsPanel
    function sortData(data, order) {
        return data.sort((a, b) => {
            const dateA = new Date(a.Date.split('/')[1], a.Date.split('/')[0] - 1);
            const dateB = new Date(b.Date.split('/')[1], b.Date.split('/')[0] - 1);
            return order === 'newest' ? dateB - dateA : dateA - dateB; // Sort in descending or ascending order based on the order parameter
        });
    }

    // Function to update the results count
    function updateResultsCount() {
        const resultsContainer = document.getElementById('blogContainer');
        const resultsCount = resultsContainer.children.length;
        const resultsNumberElement = document.getElementById('resultsNumber');
        resultsNumberElement.textContent = `Showing ${resultsCount} result(s)`;
    }

    // Define a mapping object for column names to filter IDs
    const columnToFilterIdMap = {
        'Country': 'countryFilter',
        'Cable': 'cableFilter',
        'Type': 'typeFilter',
        'Cause': 'causeFilter',
        'Company': 'companyFilter'
    };

    // Function to generate blog entries
    function generateBlogEntries(data, sortOrder) {
        clearContainer();
        populateFilterOptions(data);
        const sortedData = sortData(data, sortOrder);

        sortedData.forEach(entry => {
            const [month, year] = entry.Date.split('/');
            const date = new Date(year, month - 1); // Note: months are 0-indexed in JavaScript
            const formattedDate = date.toLocaleString('default', { month: 'long', year: 'numeric' });

            // Create a Bootstrap card for each entry
            const card = document.createElement('div');
            card.className = 'card';
            card.style.marginBottom = '10px';
            card.style.padding = '15px';
            card.style.border = '1px solid #000'; // Thin black border
            card.style.borderRadius = '0.25rem'; // Rounded corners


            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';

            const descriptionHtml = marked.parse(entry.Details);
            const cleanedDescriptionHtml = descriptionHtml.replace(/<\/?p>/g, '');

            cardBody.innerHTML = `<p><b>${formattedDate}</b> - ${cleanedDescriptionHtml}</p>`;

            // Create badges for each tag
            const tags = ['Country', 'Cable', 'Type', 'Cause', 'Company'];
            tags.forEach(tag => {
                const tagValues = entry[tag].split(', ');
                tagValues.forEach(value => {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-primary';
                    badge.textContent = value.trim();
                    badge.style.marginRight = '5px';
                    badge.style.cursor = 'pointer';
                    badge.addEventListener('click', function() {
                        const filterId = `${tag.toLowerCase()}Filter`; // Construct the filter ID dynamically
                        document.getElementById(filterId).value = value.trim();
                        // Trigger the filter function to update the displayed entries
                        filterBlogEntries();
                    });
                    cardBody.appendChild(badge);
                });
            });

            card.appendChild(cardBody);
            document.getElementById('blogContainer').appendChild(card);
        });

        // Update the results count after generating the entries
        updateResultsCount();
    }

    // Function to reset filters
    function resetFilters() {
        document.getElementById('searchBox').value = '';
        document.getElementById('yearFilter').value = '';
        document.getElementById('cableFilter').value = '';
        document.getElementById('typeFilter').value = '';
        document.getElementById('causeFilter').value = '';
        document.getElementById('countryFilter').value = '';
        document.getElementById('companyFilter').value = '';

        originalData.sort((a, b) => {
            const dateA = new Date(a.Date.split('/')[1], a.Date.split('/')[0] - 1);
            const dateB = new Date(b.Date.split('/')[1], b.Date.split('/')[0] - 1);
            return dateB - dateA; // Sort in descending order
        });

        // After resetting, update the results count
        updateResultsCount();
        
        // Update the display of active filters
        updateActiveFiltersDisplay();

        // Generate blog entries with the original data, effectively removing any filters
        generateBlogEntries(originalData); 
    }

    // Function to update the display of active filters
    function updateActiveFiltersDisplay() {
        const filters = ['yearFilter', 'cableFilter', 'typeFilter', 'causeFilter', 'countryFilter', 'companyFilter'];
        const activeFilters = filters.reduce((acc, filterId) => {
            const filterValue = document.getElementById(filterId).value;
            if (filterValue) {
                // Assuming each filter value is a single string, add it to the accumulator
                acc.push(filterValue);
            }
            return acc;
        }, []);

        const activeFiltersDiv = document.getElementById('activefilters');
        activeFiltersDiv.innerHTML = ''; // Clear the current display

        if (activeFilters.length > 0) {
            // Concatenate active filters with " AND "
            const activeFiltersText = activeFilters.join(' AND ');
            activeFiltersDiv.textContent = `Active Filter(s): ${activeFiltersText}`;
        } else {
            activeFiltersDiv.textContent = 'Active Filter(s): No active filters.';
        }
    }

    // Variable to store the filtered data
    let filteredData = [];

    // Function to filter blog entries
    function filterBlogEntries(searchQuery = '') {
        // Retrieve current filter values
        const year = document.getElementById('yearFilter').value;
        const cable = document.getElementById('cableFilter').value;
        const type = document.getElementById('typeFilter').value;
        const cause = document.getElementById('causeFilter').value;
        const country = document.getElementById('countryFilter').value;
        const company = document.getElementById('companyFilter').value;

        // Construct the URL fragment representing the current search state
        let urlFragment = '?';
        const filters = {
            yearFilter: year,
            cableFilter: cable,
            typeFilter: type,
            causeFilter: cause,
            countryFilter: country,
            companyFilter: company
        };
        Object.entries(filters).forEach(([key, value]) => {
            if (value) {
                urlFragment += `${encodeURIComponent(key)}=${encodeURIComponent(value)}&`;
            }
        });

        // Append the search query to the URL fragment
        urlFragment += `search=${encodeURIComponent(searchQuery)}`;

        // Update the browser's address bar with the constructed URL fragment
        history.pushState({}, '', urlFragment);

        // Filter the entries based on the selected filters and search query
        filteredData = originalData.filter(entry => {
            const searchMatch = searchQuery === '' || entry.Details.toLowerCase().includes(searchQuery.toLowerCase());

            // Check if the entry matches all filters
            const matchesAllFilters = Object.values(filters).every(value => {
                if (value === '') return true; // If no filter is applied, return true

                // Check if the entry matches the filter
                switch (value) {
                    case 'year':
                        return entry.Date.split('/')[1] === value;
                    case 'cable':
                        return entry.Cable.includes(value);
                    case 'type':
                        return entry.Type.includes(value);
                    case 'cause':
                        return entry.Cause.includes(value);
                    case 'country':
                        return entry.Country.includes(value);
                    case 'company':
                        return entry.Company.includes(value);
                    default:
                        return false;
                }
            });

            return searchMatch && matchesAllFilters;
        });

        // ***Update the UI***

        // Sort the filtered entries by month and year
        filteredData.sort((a, b) => {
            const dateA = new Date(a.Date.split('/')[1], a.Date.split('/')[0] - 1);
            const dateB = new Date(b.Date.split('/')[1], b.Date.split('/')[0] - 1);
            return dateB - dateA; // Sort in descending order
        });

        // After filtering, update the results count
        updateResultsCount();

        // After applying filters, update the display of active filters
        updateActiveFiltersDisplay();

        // Retrieve the current sort order from the dropdown
        const sortOrder = document.getElementById('sortOrder').value;

        // Sort the filtered entries based on the current sort order
        const sortedData = sortData(filteredData, sortOrder);
        
        // Now, generate the blog entries with the sorted and filtered data
        generateBlogEntries(sortedData, sortOrder);
    }

    // Helper function to update the URL with the current search parameters
    function updateURLWithSearchParameters(searchQuery, filters) {
        let urlFragment = '?';
        Object.entries(filters).forEach(([key, value]) => {
            if (value) {
                urlFragment += `${encodeURIComponent(key)}=${encodeURIComponent(value)}&`;
            }
        });
        urlFragment += `search=${encodeURIComponent(searchQuery)}`;
        history.pushState({}, '', urlFragment);
    }

    // Function to initialize the page with search parameters from the URL
    function initializePageFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const searchQuery = urlParams.get('search') || '';
        const filters = {};

        // Example: If the URL contains "?year=2022", set the year filter to 2022
        // You'll need to implement the logic to extract and set filter values based on your application's structure

        // Fetch data and apply initial filters and search
        fetchCSV().then(data => {
            originalData = data;
            const defaultSortOrder = "newest";
            //filterBlogEntries(searchQuery);
            generateBlogEntries(data, defaultSortOrder);
            updateActiveFiltersDisplay();
        });
    }

    // Event listeners for the search box and filter dropdowns
    document.addEventListener('DOMContentLoaded', function() {
        initializePageFromURL();

        // Event listener for the filter toggle button
        document.getElementById('filterToggle').addEventListener('click', function() {
            var filterPanel = document.getElementById('searchFilters'); // Adjusted to match the original ID
            filterPanel.classList.toggle('hidden');
        });
        
        // Event listener for the search box
        document.getElementById('searchBox').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                triggerSearch(this.value);
            }
        });

        document.getElementById('searchBox').addEventListener('blur', function() {
            triggerSearch(this.value);
        });

        document.getElementById('searchBox').addEventListener('input', function() {
            // Delay the check to allow the browser to process the "X" click
            setTimeout(() => {
                if (!this.value) {
                    // If the input is cleared, treat it as a clear action
                    triggerSearch('');
                }
            }, 100); // Adjust the delay as needed
        });

        function triggerSearch(searchQuery) {
            updateURLWithSearchParameters(searchQuery, {});
            filterBlogEntries(searchQuery);
        }

        // Event listeners for the filter dropdowns
        const filters = ['yearFilter', 'cableFilter', 'typeFilter', 'causeFilter', 'countryFilter', 'companyFilter'];
        filters.forEach(filterId => {
            document.getElementById(filterId).addEventListener('change', function() {
                const filtersObj = {}; // Collect filter values into an object
                filters.forEach(id => {
                    filtersObj[id] = document.getElementById(id).value;
                });
                updateURLWithSearchParameters('', filtersObj);
                filterBlogEntries('', filtersObj);
            });
        });

        // Event listener for the sort order dropdown
        document.getElementById('sortOrder').addEventListener('change', function() {
            const sortOrder = this.value;
            const sortedData = sortData(filteredData, sortOrder);
            generateBlogEntries(sortedData, sortOrder);
        });
    });
    
</script>
</body>
</html>
