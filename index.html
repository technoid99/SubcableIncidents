<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cable Incidents</title>
</head>
<body>

<!----TODO
The "No filter selected message is broken"
-->    
    <h1>Cable Incidents</h1>
    <p>Filter by:</p>
    <select id="dateFilter" onchange="filterBlogEntries()">
        <option value="">Date</option>
    </select>
    <select id="cableFilter" onchange="filterBlogEntries()">
        <option value="">Cable Name</option>
    </select>
    <select id="typeFilter" onchange="filterBlogEntries()">
        <option value="">Type of incident</option>
    </select>
    <select id="actionFilter" onchange="filterBlogEntries()">
        <option value="">Action</option>
    </select>
    <select id="countryFilter" onchange="filterBlogEntries()">
        <option value="">Country</option>
    </select>
    <select id="companyFilter" onchange="filterBlogEntries()">
        <option value="">Company</option>
    </select>
    <button onclick="resetFilters()">Reset Filters</button>
    <div id="selectedFilters"></div>
    <div id="blogContainer"></div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        let originalData; // Variable to store the original data from CSV

        // Function to fetch and parse the CSV file
        async function fetchCSV() {
            //const response = await fetch('cable_incidents.csv');
            const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQwM2mfSIQK_-lAYzBvFQ-EX0Jq3XfwHETZkpY8I4pahueBF28Z4j6m_d1k2_Z3tcXdw2VhpvenZNbO/pub?gid=0&single=true&output=csv');
            const csvText = await response.text();
            const parsedData = Papa.parse(csvText, { header: true }).data;
            originalData = parsedData; // Store original data
            return parsedData;
        }

        // Function to generate blog entries
        function generateBlogEntries(data) {
            const container = document.getElementById('blogContainer');
            container.innerHTML = ''; // Clear previous entries

            const dateFilter = document.getElementById('dateFilter');
            const cableFilter = document.getElementById('cableFilter');
            const typeFilter = document.getElementById('typeFilter');
            const actionFilter = document.getElementById('actionFilter');
            const countryFilter = document.getElementById('countryFilter');
            const companyFilter = document.getElementById('companyFilter');

            // Clear previous options
            dateFilter.innerHTML = '<option value="">Year</option>';
            cableFilter.innerHTML = '<option value="">Cable Name</option>';
            typeFilter.innerHTML = '<option value="">Type of incident</option>';
            actionFilter.innerHTML = '<option value="">Action</option>';
            countryFilter.innerHTML = '<option value="">Country</option>';
            companyFilter.innerHTML = '<option value="">Company</option>';

            // Extract unique values for each filter
            const uniqueValues = {
                date: new Set(),
                cable: new Set(),
                type: new Set(),
                action: new Set(),
                country: new Set(),
                company: new Set()
            };

            // Extract unique years for each entry
            data.forEach(entry => {
                const year = entry.Date.split('/')[1]; // Assuming the date format is MM/YYYY
                uniqueValues.date.add(year);
            });

            // Populate the date dropdown with unique years
            uniqueValues.date.forEach(year => {
                dateFilter.innerHTML += `<option value="${year}">${year}</option>`;
            });

            data.forEach(entry => {
                // Split and trim values, then add to the corresponding filter if not empty
                entry.Date.split(', ').forEach(date => {
                    const trimmedDate = date.trim();
                    if (trimmedDate !== '') {
                        uniqueValues.date.add(trimmedDate);
                    }
                });
                entry['Cable Name'].split(', ').forEach(cable => {
                    const trimmedCable = cable.trim();
                    if (trimmedCable !== '') {
                        uniqueValues.cable.add(trimmedCable);
                    }
                });
                entry['Type of incident'].split(', ').forEach(type => {
                    const trimmedType = type.trim();
                    if (trimmedType !== '') {
                        uniqueValues.type.add(trimmedType);
                    }
                });
                entry.Actions.split(', ').forEach(action => {
                    const trimmedAction = action.trim();
                    if (trimmedAction !== '') {
                        uniqueValues.action.add(trimmedAction);
                    }
                });
                entry.Countries.split(', ').forEach(country => {
                    const trimmedCountry = country.trim();
                    if (trimmedCountry !== '') {
                        uniqueValues.country.add(trimmedCountry);
                    }
                });
                entry.Companies.split(', ').forEach(company => {
                    const trimmedCompany = company.trim();
                    if (trimmedCompany !== '') {
                        uniqueValues.company.add(trimmedCompany);
                    }
                });
            });

            // Populate dropdown options
            uniqueValues.cable.forEach(value => {
                cableFilter.innerHTML += `<option value="${value}">${value}</option>`;
            });
            uniqueValues.type.forEach(value => {
                typeFilter.innerHTML += `<option value="${value}">${value}</option>`;
            });
            uniqueValues.action.forEach(value => {
                actionFilter.innerHTML += `<option value="${value}">${value}</option>`;
            });
            uniqueValues.country.forEach(value => {
                countryFilter.innerHTML += `<option value="${value}">${value}</option>`;
            });
            uniqueValues.company.forEach(value => {
                companyFilter.innerHTML += `<option value="${value}">${value}</option>`;
            });

            // Sort the filtered entries by month and year
            data.sort((a, b) => {
                const dateA = new Date(a.Date.split('/')[1], a.Date.split('/')[0] - 1);
                const dateB = new Date(b.Date.split('/')[1], b.Date.split('/')[0] - 1);
                return dateB - dateA; // Sort in descending order
            });

            // Generate blog entries
            data.forEach(entry => {
                // Parse the date string to extract the month and year
                const [month, year] = entry.Date.split('/');
                const date = new Date(year, month - 1); // Note: months are 0-indexed in JavaScript
                const formattedDate = date.toLocaleString('default', { month: 'short', year: 'numeric' });

                // Use the formatted date in the blog entry
                const blogEntry = document.createElement('div');
                // Parse the Description field as Markdown
                const descriptionHtml = marked.parse(entry.Details);
                const cleanedDescriptionHtml = descriptionHtml.replace(/<\/?p>/g, '');
                blogEntry.innerHTML = `<p><b>${formattedDate}</b> - ${cleanedDescriptionHtml}</p>`;                container.appendChild(blogEntry);
            });
        }

        // Initialization
        fetchCSV().then(data => {
            console.log(data);
            originalData = data; // Store original data
            resetFilters(); // Call resetFilters to display all entries initially
        });

        // Function to reset filters
        function resetFilters() {
            document.getElementById('dateFilter').value = '';
            document.getElementById('cableFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('actionFilter').value = '';
            document.getElementById('countryFilter').value = '';
            document.getElementById('companyFilter').value = '';

            originalData.sort((a, b) => {
                const dateA = new Date(a.Date.split('/')[1], a.Date.split('/')[0] - 1);
                const dateB = new Date(b.Date.split('/')[1], b.Date.split('/')[0] - 1);
                return dateB - dateA; // Sort in descending order
            });

            // Generate blog entries with the original data, effectively removing any filters
            generateBlogEntries(originalData);
        }

        function updateSelectedFilters() {
            const selectedFiltersContainer = document.getElementById('selectedFilters');
            selectedFiltersContainer.innerHTML = ''; // Clear previous selections

            const filters = {
                date: document.getElementById('dateFilter').value,
                cable: document.getElementById('cableFilter').value,
                type: document.getElementById('typeFilter').value,
                action: document.getElementById('actionFilter').value,
                country: document.getElementById('countryFilter').value,
                company: document.getElementById('companyFilter').value
            };

            let selectedFiltersText = 'Selected Filters: ';
            let hasSelectedFilters = false;

            for (const [key, value] of Object.entries(filters)) {
                if (value !== '') {
                    selectedFiltersText += `${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}, `;
                    hasSelectedFilters = true;
                }
            }

            if (hasSelectedFilters) {
                // Remove the last comma and space
                selectedFiltersText = selectedFiltersText.slice(0, -2);
                selectedFiltersContainer.textContent = selectedFiltersText;
                selectedFiltersContainer.textContent = 'boo'; //debug
            } else {
                selectedFiltersContainer.textContent = 'No filters selected.';
            }
        }

        // Function to filter blog entries
        function filterBlogEntries() {
            const date = document.getElementById('dateFilter').value;
            const cable = document.getElementById('cableFilter').value;
            const type = document.getElementById('typeFilter').value;
            const action = document.getElementById('actionFilter').value;
            const country = document.getElementById('countryFilter').value;
            const company = document.getElementById('companyFilter').value;

            // After filtering the entries based on the selected filters
            const filteredData = originalData.filter(entry => {
                const entryYear = entry.Date.split('/')[1]; // Extract the year from the entry's date
                return (date === '' || entryYear === date) &&
                    (cable === '' || entry['Cable Name'].split(', ').includes(cable)) &&
                    (type === '' || entry['Type of incident'].split(', ').includes(type)) &&
                    (action === '' || entry.Actions.split(', ').includes(action)) &&
                    (country === '' || entry.Countries.split(', ').includes(country)) &&
                    (company === '' || entry.Companies.split(', ').includes(company));
            });

            // Sort the filtered entries by month and year
            filteredData.sort((a, b) => {
                const dateA = new Date(a.Date.split('/')[1], a.Date.split('/')[0] - 1);
                const dateB = new Date(b.Date.split('/')[1], b.Date.split('/')[0] - 1);
                return dateB - dateA; // Sort in descending order
            });

            // Now, generate the blog entries with the sorted and filtered data
            generateBlogEntries(filteredData);
        }

    
        // Call updateSelectedFilters whenever a filter is changed
        document.getElementById('dateFilter').addEventListener('change', updateSelectedFilters);
        document.getElementById('cableFilter').addEventListener('change', updateSelectedFilters);
        document.getElementById('typeFilter').addEventListener('change', updateSelectedFilters);
        document.getElementById('actionFilter').addEventListener('change', updateSelectedFilters);
        document.getElementById('countryFilter').addEventListener('change', updateSelectedFilters);
        document.getElementById('companyFilter').addEventListener('change', updateSelectedFilters);

        // Also call updateSelectedFilters when the page is loaded to initialize the display
        document.addEventListener('DOMContentLoaded', updateSelectedFilters);  
        
    </script>
</body>
</html>
